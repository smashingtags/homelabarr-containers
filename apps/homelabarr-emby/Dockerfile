## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# Docker owned by homelabarr       #
# Docker Maintainer smashingtags   #
####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
FROM ghcr.io/linuxserver/baseimage-ubuntu:jammy as buildstage
LABEL org.opencontainers.image.source="https://github.com/smashingtags/homelabarr-containers"

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG VERSION="4.9.3.0"
ARG BRANCH="master"

ENV DEBIAN_FRONTEND="noninteractive"

RUN \
   echo "**** update runtime packages ****" && \
     apt-get update -yqq && \
   echo "**** install packages ****" && \
     apt-get install -yqq aria2 unrar  uuid-runtime cpio jq rpm2cpio && \
  echo "**** set arch for emby ****" && \
   case $TARGETPLATFORM in \
    "linux/amd64") export ARCH=x86_64 ;; \
    "linux/arm64") export ARCH=aarch64 ;; \
   esac \
   && \
  echo "**** install emby ****" && \
    mkdir -p /app/emby && \
    aria2c -d /tmp -o emby.rpm "https://github.com/MediaBrowser/Emby.Releases/releases/download/${VERSION}/emby-server-rpm_${VERSION}_${ARCH}.rpm" && \
    cd /tmp && rpm2cpio emby.rpm | cpio -i --make-directories && \
    echo -e "UpdateMethod=docker\nBranch=${BRANCH}\nPackageVersion=${VERSION}\nPackageAuthor=[dockserver.io](https://dockserver.io)" > /app/package_info && \
  echo "**** unset arch ****" && \
    unset ARCH && \
  echo "**** cleanup ****" && \
    mv -t /app/emby \
     /tmp/opt/emby-server/system/* \
     /tmp/opt/emby-server/lib/* \
     /tmp/opt/emby-server/extra/lib/* \
     /tmp/opt/emby-server/bin/ff* \
     /tmp/opt/emby-server/etc

### FINALIMAGE
FROM ghcr.io/linuxserver/baseimage-ubuntu:jammy

ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG VERSION

ENV NVIDIA_DRIVER_CAPABILITIES="" \
    DEBIAN_FRONTEND="noninteractive"

RUN \
   case $TARGETPLATFORM in \
    'linux/amd64') \
         export NVIDIA_DRIVER_CAPABILITIES="compute,video,utility" && \
         export ARCH=amd64 && \
      echo "**** install runtime packages ****" && \
         apt-get update -yqq && \
      echo "**** install Intel packages ****" && \
         apt-get install -yqq intel-opencl-icd intel-gpu-tools i965-va-driver-shaders va-driver-all mesa-vulkan-drivers gpg-agent libmfx1 ocl-icd-libopencl1; \
    ;; \
    'linux/arm64') export ARCH=arm64 && unset NVIDIA_DRIVER_CAPABILITIES ;; \
   esac \
   && \
   echo "**** install runtime packages ****" && \
     apt-get update -yqq && \
   echo "**** set permissions ****" && \
     usermod -d /app abc && \
  echo "**** cleanup ****" && \
     apt-get remove -yqq aria2 jq software-properties-common gpg-agent && \
     apt-get autoremove -yqq && apt-get clean -yqq && \
     rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/

COPY --from=buildstage /app/emby /app/emby
COPY --chown=abc ./apps/homelabarr-emby/root/ /

EXPOSE 8096 8920

VOLUME /config
##EOF

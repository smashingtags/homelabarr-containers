## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# Docker owned by homelabarr       #
# Docker Maintainer smashingtags   #
####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
FROM ghcr.io/linuxserver/baseimage-ubuntu:focal
LABEL org.opencontainers.image.source="https://github.com/smashingtags/homelabarr-containers"


ARG TARGETPLATFORM
ARG BUILDPLATFORM
ARG VERSION="10.11.0+ubu2004"
ARG BRANCH="master"

ENV NVIDIA_DRIVER_CAPABILITIES="compute,video,utility" \
    DEBIAN_FRONTEND="noninteractive"

RUN \
   echo "**** update packages ****" && \
     apt-get update -yqq && \
   echo "**** install build packages ****" && \
     apt-get install --no-install-recommends -yqq gnupg curl software-properties-common && \
     apt-get update -yqq && apt-get install gnupg2 wget ca-certificates lsb-release software-properties-common -yqq && \
   case $TARGETPLATFORM in \
    'linux/amd64') \
         export ARCH='amd64' && \
         mkdir -p /usr/share/keyrings && \
         curl -o /usr/share/keyrings/jellyfin_team.gpg.key -L https://repo.jellyfin.org/ubuntu/jellyfin_team.gpg.key && \
         echo "deb [trusted=yes arch=amd64 signed-by=/usr/share/keyrings/jellyfin_team.gpg.key] https://repo.jellyfin.org/ubuntu focal main" > /etc/apt/sources.list.d/jellyfin.list && \
         curl -o /usr/share/keyrings/intel-graphics.key -L https://repositories.intel.com/graphics/intel-graphics.key && \
         echo "deb [trusted=yes arch=amd64 signed-by=/usr/share/keyrings/intel-graphics.key] https://repositories.intel.com/graphics/ubuntu focal main" > /etc/apt/sources.list.d/intel.list ; \
    ;; \
    'linux/arm64') \
        export ARCH='arm64' && \
        unset NVIDIA_DRIVER_CAPABILITIES && \
        mkdir -p /usr/share/keyrings && \
        curl -o /usr/share/keyrings/jellyfin_team.gpg.key -L https://repo.jellyfin.org/ubuntu/jellyfin_team.gpg.key && \
        echo "deb [trusted=yes arch=arm64 signed-by=/usr/share/keyrings/jellyfin_team.gpg.key] https://repo.jellyfin.org/ubuntu focal main" > /etc/apt/sources.list.d/jellyfin.list && \
        curl -s https://keyserver.ubuntu.com/pks/lookup?op=get\&search=0x6587ffd6536b8826e88a62547876ae518cbcf2f2 | apt-key add - && \
        echo "deb [trusted=yes] http://ppa.launchpad.net/ubuntu-raspi2/ppa-nightly/ubuntu focal main" > /etc/apt/sources.list.d/raspbins.list ; \
    ;; \
   esac \
   && \
   echo "**** install runtime packages ****" && \
     apt-get update -yqq && \
   echo "**** install packages ****" && \
     apt-get install --no-install-recommends -yqq at jellyfin-ffmpeg jellyfin-web libfontconfig1 libfreetype6 libssl1.1 && \
   echo "**** install jellyfin ****" && \
     apt-get install --no-install-recommends -yqq jellyfin-server=10.11.0+ubu2004 && \
   case $TARGETPLATFORM in \
    'linux/amd64') apt-get update -yqq && apt-get install --no-install-recommends -yqq mesa-va-drivers intel-media-va-driver-non-free beignet-opencl-icd intel-media-va-driver-non-free i965-va-driver libva2=2.13.0+i643~u20.04 libigdgmm11=21.3.3+i643~u20.04 intel-media-va-driver-non-free=21.4.1+i643~u20.04;; \
    'linux/arm64') apt-get update -yqq && apt-get install --no-install-recommends -yqq libomxil-bellagio0 libomxil-bellagio-bin libraspberrypi0;; \
   esac \
   && \
   echo "**** set permissions ****" && \
     usermod -d /app abc && \
   echo "**** cleanup ****" && \
     apt-get remove -yqq aria2 jq software-properties-common gpg-agent && \
   apt-get autoremove -yqq && apt-get clean -yqq && \
   rm -rf /tmp/* /var/lib/apt/lists/* /var/tmp/

COPY --chown=abc ./apps/homelabarr-jellyfin/root/ /

VOLUME /config
##EOF
